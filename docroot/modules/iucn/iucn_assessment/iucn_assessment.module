<?php

use Drupal\role_hierarchy\RoleHierarchyHelper;
use Drupal\Core\Form\FormStateInterface;
use Drupal\user\Entity\Role;
use Drupal\Core\Entity\EntityInterface;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

function iucn_assessment_theme() {
  return [
    'assessment_horizontal_tabs' => array(
      'render element' => 'element',
      'template' => 'assessment-horizontal-tabs',
      'file' => 'templates/theme.inc',
    ),
    'field_group_html_element_list' => [
      'render element' => 'element',
      'template' => 'field-group-html-element-list',
    ],
    'rating_image_switcher' => [
      'render element' => 'element',
      'template' => 'rating-image-switcher',
    ],
  ];

}

/**
 * Implements hook_theme_suggestions_alter().
 *
 * @param array $suggestions
 * @param array $variables
 * @param $hook
 */
function iucn_assessment_theme_suggestions_alter(array &$suggestions, array $variables, $hook) {
  switch ($hook) {
    case 'assessment_horizontal_tabs':
      $element = $variables['element'];

      $name = $element['#group_name'];
      $entity_type = $element['#entity_type'];
      $bundle = $element['#bundle'];

      $wrapper = '';
      if (isset($element['#wrapper_element'])) {
        $wrapper = $element['#wrapper_element'];
        $suggestions[] = $hook . '__' . $wrapper;
      }

      $suggestions[] = $hook . '__' . $entity_type;
      $suggestions[] = $hook . '__' . $bundle;
      $suggestions[] = $hook . '__' . $name;

      if ($wrapper) {
        $suggestions[] = $hook . '__' . $entity_type . '__' . $wrapper;
      }

      $suggestions[] = $hook . '__' . $entity_type . '__' . $bundle;
      $suggestions[] = $hook . '__' . $entity_type . '__' . $name;

      if ($wrapper) {
        $suggestions[] = $hook . '__' . $entity_type . '__' . $bundle . '__' . $wrapper;
      }
      $suggestions[] = $hook . '__' . $entity_type . '__' . $bundle . '__' . $name;
      break;
  }

}

/**
 * Implements hook_entity_form_display_alter().
 */
function iucn_assessment_entity_form_display_alter(&$form_display, $context) {
  $id = $context['entity_type'] . '.' . $context['bundle'];
  if ($id == 'node.site_assessment') {
    $path = \Drupal::request()->getpathInfo();
    $arg = explode('/', $path);
    $tab = $arg[3];
    $form_modes = \Drupal::entityManager()->getFormModes('node');
    if ($tab && !empty($form_modes[$tab])) {
      $entity_manager = \Drupal::entityTypeManager();
      $entity_default_display = $entity_manager->getStorage('entity_form_display')->load($id . '.' . $tab);
      if ($entity_default_display) {
        $form_display = $entity_default_display;
      }
    }
  }
}


function template_preprocess_rating_image_switcher(&$variables) {
  $element = $variables['element'];
  $variables['images'] = $element['#images'];
  $variables['years'] = $element['#years'];

  $iucn_config = \Drupal::config('iucn_who.settings');
  $year = $iucn_config->get('assessment_year');
  $variables['active_year'] = $year;

}

function template_preprocess_field_group_html_element_list(&$variables) {

  $element = $variables['element'];

  if (!empty($element['#title']) && !empty($element['#title_element'])) {
    $variables['title_element'] = $element['#title_element'];
    $variables['title'] = $element['#title'];
  }

  $variables['wrapper_element'] = $element['#wrapper_element'];
  $variables['attributes'] = $element['#attributes'];
  $variables['list'] = $element['list'];

}


/**
 * Implements hook_ENTITY_TYPE_presave().
 */
function iucn_assessment_node_presave(Drupal\node\Entity\Node $node) {
  if ($node->bundle() == 'site' && !$node->isNew()) {
    _iucn_assessment_set_site_assessments($node);
  }
  elseif ($node->bundle() == 'site_assessment') {
    /** @var \Drupal\iucn_assessment\Plugin\AssessmentWorkflow $workflow_service */
    $workflow_service = \Drupal::service('iucn_assessment.workflow');
    $workflow_service->assessmentPreSave($node);
  }
}

/**
 * Implements hook_node_update().
 */
function iucn_assessment_node_update(Drupal\node\Entity\Node $node) {
  if ($node->bundle() == 'site_assessment' && !empty($node->field_as_site->entity)) {
    $site = $node->field_as_site->entity;
    if (!empty($site)) {
      // Reset site assessments for this site.
      _iucn_assessment_set_site_assessments($site);
      $site->save();
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function iucn_assessment_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  global $_iucn_assessment_is_latest_assessment;
  // Show a notice on PDF print that when is not latest.
  if ($entity->bundle() == 'site' && $view_mode == 'pdf') {
    if (empty($_iucn_assessment_is_latest_assessment)) {
      $build['#attributes']['class'][] = 'showing-old-assessment';
    }
    else {
      $build['#attributes']['class'][] = 'showing-latest-assessment';
    }
  }
}

/**
 * Implements hook_preprocess_field().
 */
function iucn_assessment_preprocess_field(&$variables) {
  switch ($variables['field_name']) {
    case 'field_designation':
      $display_year = iucn_pdf_assessment_year_display($variables['element']['#object']);
      if ($display_year == \Drupal::service('iucn_assessment.assessments_year')->first()) {
        $variables['attributes']['class'][] = 'invisible';
      }
      break;

    case 'field_assessments':
      $variables['element']['#cache']['contexts'][] = 'url';
      if (!empty($variables['items'])) {
        $iucn_config = \Drupal::config('iucn_who.settings');
        $config_year = $iucn_config->get('assessment_year');
        $display_year = iucn_pdf_assessment_year_display($variables['element']['#object']);
        $showing_item = NULL;
        foreach ($variables['items'] as $item) {
          /* @var \Drupal\node\Entity\Node $assessment */
          $assessment = $item['content']['#node'];
          if ($assessment->field_as_cycle->value == $display_year
            && $assessment->access('view')) {
            $showing_item = $item;
            $variables['element']['#cache']['tags'][] = 'node:' . $assessment->id();
            break;
          }
        }

        // Handle custom revision display
        $node_revision = _iucn_assessment_display_negociate_assessment_revision();
        if ($node_revision && $node_revision->id() == $showing_item['content']['#node']->id()) {
          $showing_item['content']['#node'] = $node_revision;
          drupal_set_message(t('Showing assessment revision from @revision',
            ['@revision' => date('Y-m-d H:i', $node_revision->getRevisionCreationTime())]));
        }

        $variables['attributes']['class'][] = $config_year == $display_year ? 'showing-latest-assessment' : 'showing-old-assessment';
        $variables['items'] = !empty($showing_item) ? [$showing_item] : [];

      }
      break;

    case 'field_as_protection':
      // Sort this field by taxonomy term.
      if (empty($variables['items'][0]['content']['#paragraph'])) {
        break;
      }
      $items = $variables['items'];
      usort($items,
      function($a, $b) {
        $a_weight = 0;
        if ($a['content']['#paragraph']->field_as_protection_topic->count()) {
          $a_weight = $a['content']['#paragraph']->field_as_protection_topic->entity->getWeight();
        }
        $b_weight = 0;
        if ($b['content']['#paragraph']->field_as_protection_topic->count()) {
          $b_weight = $b['content']['#paragraph']->field_as_protection_topic->entity->getWeight();
        }
        if ($a_weight == $b_weight) {
          return 0;
        }
        return ($a_weight < $b_weight) ? -1 : 1;
      }
      );

      // Change labels inside the PDF if it's a 2014 assessment.
      if ($variables['element']['#object']->field_as_cycle->value == '2014') {
        foreach ($items as $item) {
          $topic = $item['content']['#paragraph']->field_as_protection_topic->entity;
          if (!empty($topic->field_name_2014->value)) {
            $topic->name->value = $topic->field_name_2014->value;
          }
        }
      }
      $variables['items'] = $items;
      break;

    case 'field_as_threats_current':
    case 'field_as_threats_potential':
      // Change labels inside the PDF if it's a 2014 assessment.
      if (empty($variables['items'][0]['content']['#paragraph']) ||
        $variables['element']['#object']->field_as_cycle->value != '2014'
      ) {
        break;
      }
      foreach ($variables['items'] as $item) {
        $categories = $item['content']['#paragraph']->field_as_threats_categories;
        foreach ($categories as $category) {
          $category = $category->entity;
          if (!empty($category->field_name_2014->value)) {
            $category->name->value = $category->field_name_2014->value;
          }
        }
      }
      break;

    case 'field_as_threats_categories':
      // Hide the parent terms for this field - show only sub-categories
      /*if (count($variables['items']) == 2) {
        unset($variables['items'][0]);
      }*/
      break;

    case 'field_as_references':
      // Sort this field by string alphabetically.
      if (empty($variables['items'][0]['content']['#context']['value'])) {
        break;
      }

      // Transform links to url and trim.
      /** @var \Drupal\filter\FilterPluginManager $filter_manager */
      $filter_manager = \Drupal::service('plugin.manager.filter');
      /** @var \Drupal\filter\Plugin\FilterBase $filter */
      $filter = $filter_manager->createInstance('filter_url');
      $filter->settings['filter_url_length'] = 60;

      $items = $variables['items'];
      foreach ($items as &$item) {
        $value = _filter_html_escape($item['content']['#context']['value']);
        $item['content']['#template'] = '{{ value|raw|nl2br }}';
        $value = $filter->process($value, 'en');
        $item['content']['#context']['value'] = $value->__toString();
      }

      usort($items,
        function ($a, $b) {
          $a_string = $a['content']['#context']['value'];
          $b_string = $b['content']['#context']['value'];
          return (strcmp($a_string, $b_string));
        }
      );
      $variables['items'] = $items;
      break;

    case 'field_as_benefits':
      // Hide "nature conservation values" benefits for 2017 assessments.
      if (
        empty($variables['items'][0]['content']['#paragraph'])
        || $variables['element']['#object']->field_as_cycle->value == \Drupal::service('iucn_assessment.assessments_year')->first()
      ) {
        break;
      }
      foreach ($variables['items'] as $idx => &$item) {
        if ($tid = $item['content']['#paragraph']->field_as_benefits_category->target_id) {
          $storage = \Drupal::service('entity_type.manager')
            ->getStorage('taxonomy_term');
          $parent = $storage->loadParents($tid);
          $parent = reset($parent);
          if ($parent && $parent->getName() == t('Nature conservation values')) {
            unset($variables['items'][$idx]);
          }
        }
      }
      break;

    case 'field_as_threats_extent':
      foreach ($variables['items'] as $key => $item) {
        $variables['items'][$key]['content']['#plain_text'] = ', ' . $variables['items'][$key]['content']['#plain_text'];
      }
      break;

    default:
      break;
  }
}

function _iucn_assessment_display_negociate_assessment_revision(\Drupal\node\Entity\Node $node = NULL) {
  if (empty($node)) {
    // Load site from url.
    $request = \Drupal::request();
    if ($request->attributes->get('_route') !== 'entity.node.canonical') {
      return NULL;
    }
    $node = $request->attributes->get('node');
  }
  if ($node->bundle() != 'site') {
    return NULL;
  }
  $request = \Drupal::request();
  $revision = $request->get('revision');
  if (empty($revision)) {
    return NULL;
  }
  /** @var Drupal\node\Entity\Node $node_revision */
  $node_revision = \Drupal::entityTypeManager()
    ->getStorage('node')
    ->loadRevision($revision);
  if (empty($node_revision)) {
    return NULL;
  }
  foreach ($node->field_assessments as $idx => $assessment) {
    if ($node_revision && $node_revision->id() == $assessment->entity->id()) {
      drupal_set_message(t('Showing assessment revision @revision', ['@revision' => $revision]));
      return $node_revision;
    }
  }
  return NULL;
}

function _iucn_assessment_set_site_assessments($node) {
  // Set assessment field.
  $query = \Drupal::entityQuery('node');
  $query->condition('type', 'site_assessment');
  $query->condition('field_as_site.target_id', $node->id());
  $entity_ids = $query->execute();
  $field_values = [];
  if (!empty($entity_ids)) {
    foreach ($entity_ids as $id) {
      $field_values[] = ['target_id' => $id];
    }
  }
  $node->field_assessments = $field_values;

  $iucn_config = \Drupal::config('iucn_who.settings');
  $current_year = $iucn_config->get('assessment_year');

  // Set current assessment.
  $query = \Drupal::entityQuery('node');
  $query->condition('status', 1);
  $query->condition('type', 'site_assessment');
  $query->condition('field_as_site.target_id', $node->id());
  $query->condition('field_as_cycle.value', $current_year);
  $query->range(0, 1);
  $query->sort('changed', 'desc');
  $entity_ids = $query->execute();

  $field_values = [];
  if (!empty($entity_ids)) {
    $field_values[] = ['target_id' => current($entity_ids)];
  }
  $node->field_current_assessment = $field_values;


}

function iucn_assessment_field_group_pre_render(&$element, &$group, &$rendering_object) {
  global $_iucn_assessment_display_year;
  if (!empty($element['#group_name']) && $element['#group_name'] == 'group_conservation_outlook') {
    if (!empty($element['field_as_end_date']['#object']->field_as_cycle)) {
      $element['#title'] = $element['field_as_end_date']['#object']->field_as_cycle->value . ' ' . $element['#title'];
    }
  }

  // Specific request to hide show only for 2017 assessments.
  if (!empty($element['#group_name'])
    && ($element['#group_name'] == 'group_key_conservation_issues' || $element['#group_name'] == 'group_community')) {
    if (!empty($_iucn_assessment_display_year) && $_iucn_assessment_display_year != \Drupal::service('iucn_assessment.assessments_year')->first()) {
      $element['#access'] = FALSE;
    }
  }
}

/**
 * Implements hook_webform_element_alter().
 */
function iucn_assessment_webform_element_alter(array &$element, \Drupal\Core\Form\FormStateInterface $form_state, array $context) {
  if ($element['#webform_id'] == 'site_feedback--subject' && $element['#webform_key'] == 'subject') {
    /* @var \Drupal\node\Entity\Node $node */
    $node = \Drupal::routeMatch()->getParameter('node');
    if (is_object($node) && $node->bundle() == 'site') {
      $element['#default_value'] = t('Feedback on @site', ['@site' => $node->getTitle()]);
      $element['#attributes']['readonly'] = 'readonly';
    }
  }
}

/**
 * Implements hook_ds_pre_render_alter().
 */
function iucn_assessment_ds_pre_render_alter(array &$layout_render_array, array $context, array &$vars) {
  /** @var \Drupal\node\Entity\Node $entity */
  $entity = $context['entity'];
  if ($entity->bundle() == 'site_assessment') {
    $year = $entity->field_as_cycle->value;
    // 2017 assessments shouldn't have "Other important biodiversity values".
    if ($year != \Drupal::service('iucn_assessment.assessments_year')->first()) {
      unset(
        $vars['content']['full_assessment_values']['group_assessment_information']['group_state_and_trend_of_values']['group_assessing_current_state']['display_field_copy:node-other_biodiv_values']
      );
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function iucn_assessment_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $current_user = \Drupal::currentUser();
  $is_user_1 = $current_user->id() == 1;
  if ($form_id == 'node_site_assessment_form') {
    if ($is_user_1) {
      return;
    }

    // Hide revision log message.
    $form['advanced']['#access'] = FALSE;
    // Hide publish settings.
    $form['footer']['#access'] = FALSE;
    foreach (['field_coordinator', 'field_assessor', 'field_reviewers'] as $field) {
      $form[$field]['#access'] = FALSE;
    }
  }
  // Assessment user fields are only enabled during certain states.
  // Additionally, some of them are required for moving to other states.
  elseif ($form_id == 'node_site_assessment_edit_form') {
    // Hide all revision related settings and check if a new revision should
    // be created in hook_node_presave().
    $form['revision']['#default_value'] = FALSE;
    $form['revision']['#disabled'] = FALSE;
    $form['revision']['#access'] = FALSE;
    // Hide revision log message.
    $form['advanced']['#access'] = FALSE;

    // Hide state change scheduling.
    if (!empty($form['field_state']['widget'][0]['workflow_scheduling'])) {
      $form['field_state']['widget'][0]['workflow_scheduling']['#access'] = FALSE;
    }

    // Do not alter the form for user 1.
    if ($is_user_1) {
      return;
    }

    // Hide publish settings.
    $form['footer']['#access'] = FALSE;

    $form['#validate'][] = '_iucn_assessment_edit_form_validate';
    /** @var \Drupal\iucn_assessment\Plugin\AssessmentWorkflow $workflow_service */
    $workflow_service = \Drupal::service('iucn_assessment.workflow');
    $weight = RoleHierarchyHelper::getAccountRoleWeight($current_user);
    $coordinator_weight = Role::load('coordinator')->getWeight();
    /** @var \Drupal\node\NodeInterface $node */
    $node = $form_state->getFormObject()->getEntity();
    foreach (['field_coordinator', 'field_assessor', 'field_reviewers'] as $field) {
      if ($weight <= $coordinator_weight) {
        // Enable these fields only in certain assessment states
        // for roles >= coordinators.
        $enabled = $workflow_service->isFieldEnabledForAssessment($field, $node);
        $form[$field]['#access'] = $enabled;
      }
      else {
        // Hide the field for lower roles.
        $form[$field]['#access'] = FALSE;
      }
    }
  }
  elseif (in_array($form_id, ['user_form', 'user_register_form'])) {
    $form['account']['roles']['#access'] = $current_user->hasPermission('administer users');
  }
}

/**
 * Callback validation function for node_site_assessment_edit_form.
 */
function _iucn_assessment_edit_form_validate($form, FormStateInterface $form_state) {
  /** @var \Drupal\workflow\Entity\WorkflowTransitionInterface $transition */
  $transition = $form_state->getValue('field_state')[0]['workflow_transition'];
  $state = $transition->getToState();
  $entity = $transition->getTargetEntity();
  /** @var \Drupal\iucn_assessment\Plugin\AssessmentWorkflow $workflow_service */
  $workflow_service = \Drupal::service('iucn_assessment.workflow');
  foreach (['field_coordinator', 'field_assessor', 'field_reviewers'] as $field) {
    $value = $form_state->getValue($field);
    $required = $workflow_service->isFieldRequiredForState($field, $state->id());
    if ($required && empty($value)) {
      $form_state->setErrorByName($field, t('<b>@field</b> is required before moving to state <b>@state</b>', [
        '@field' => $entity->{$field}->getFieldDefinition()->getLabel(),
        '@state' => $state->label(),
      ]));
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_prepare_form().
 */
function iucn_assessment_node_prepare_form(EntityInterface $entity, $operation, FormStateInterface $form_state) {
  // The revision edit page is actually the node edit page.
  // We need to change the form entity to the selected revision.
  if ($entity->bundle() == 'site_assessment' && $operation == 'edit') {
    $node_revision = \Drupal::routeMatch()->getParameter('node_revision');
    if (!empty($node_revision)) {
      $revision = \Drupal::entityTypeManager()
        ->getStorage('node')
        ->loadRevision($node_revision);
      if (empty($revision)) {
        throw new NotFoundHttpException();
      }
      $revision->setNewRevision(FALSE);
      $revision->isDefaultRevision(FALSE);
      /** @var \Drupal\Core\Entity\RevisionableStorageInterface $storage */
      $storage = \Drupal::entityTypeManager()->getStorage('node');
      $form_state->getFormObject()->setEntity($revision);
    }
  }
}

function iucn_assessment_entity_type_alter(array &$entity_types) {
  foreach ($entity_types as $entity_type) {
    $constraints = $entity_type->getConstraints();
    unset($constraints['EntityUntranslatableFields']);
    $entity_type->setConstraints($constraints);
  }
}

/**
 * Implements hook_validation_constraint_alter().
 */
function iucn_assessment_validation_constraint_alter(array &$definitions) {
  if (isset($definitions['EntityChanged'])) {
    $definitions['EntityChanged']['class'] = 'Drupal\iucn_assessment\Plugin\Validation\Constraint\IucnAssessmentEntityChangedConstraint';
  }
}
