<?php

/**
 * Implements hook_node_update().
 */
function iucn_assessment_node_update(Drupal\node\Entity\Node $node) {
  // Assign to the site the current assessment if it's the latest one.
  if ($node->bundle() == 'site_assessment'
    && $node->isPublished()
    && !empty($node->field_as_site->entity)) {
    $site = $node->field_as_site->entity;
    if (empty($site->field_current_assessment->entity)) {
      $site->field_current_assessment = [['target_id' => $node->id()]];
    }
    else {
      $curr_date = $node->field_as_cycle->value;
      $date = $site->field_current_assessment->entity->field_as_cycle->value;
      if ($curr_date > $date) {
        $site->field_current_assessment = [['target_id' => $node->id()]];
      }
    }
    $site->save();
  }
}

/**
 * Implements hook_ENTITY_TYPE_view_alter().
 */
function iucn_assessment_node_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {
//  if ($display->id() == 'node.site.default') {
//    foreach ($build['field_assessments']['#items'] as $assessment) {
//      if ($assessment->entity->field_as_cycle->value == 2017) {
//        $build['field_assessments']['#items'] = [$assessment];
//        break;
//      }
//    }
//    dpm($build['field_assessments']['#items']);
//  }
}

function iucn_assessment_year_display(\Drupal\node\Entity\Node $site) {
  if ($site->field_assessments->count() == 0) {
    return NULL;
  }

  $iucn_config = \Drupal::config('iucn_who.settings');
  /* @var \Drupal\iucn_pdf\ParamHelper $param_helper  */
  $param_helper = \Drupal::service('iucn_pdf.param_helper');
  $year = $param_helper->get('year', $iucn_config->get('assessment_year'));

  $active_date = $site->field_assessments->entity->field_as_cycle->value;
  foreach ($site->field_assessments as $assessment) {
    if ($assessment->entity->field_as_cycle->value == $year) {
      $active_date = $year;
      break;
    }
  }
  return $active_date;
}

function iucn_assessment_preprocess_field(&$variables) {
  if ($variables['field_name'] == 'field_assessments') {
    $variables['element']['#cache']['contexts'][] = 'url';
    if (empty($variables['items'])) {
      // TODO
    }
    else {
      $display_year = iucn_assessment_year_display($variables['element']['#object']);
      $showing_item = NULL;
      foreach ($variables['items'] as $item) {
        /* @var \Drupal\node\Entity\Node $assessment */
        $assessment = $item['content']['#node'];
        if ($assessment->field_as_cycle->value == $display_year) {
          $showing_item = $item;
          $variables['element']['#cache']['tags'][] = 'node:' . $assessment->id();
          break;
        }
      }
      $variables['items'] = !empty($showing_item) ? [$showing_item] : [];
    }
  }
}

function iucn_assessment_node_presave(Drupal\node\Entity\Node $node) {
  if ($node->bundle() == 'site' && !$node->isNew()) {
    $query = \Drupal::entityQuery('node');
    $query->condition('status', 1);
    $query->condition('type', 'site_assessment');
    $query->condition('field_as_site.target_id', $node->id());
    $entity_ids = $query->execute();
    $field_values = [];
    if (!empty($entity_ids)) {
      foreach ($entity_ids as $id) {
        $field_values[] = ['target_id' => $id];
      }
    }
    $node->field_assessments = $field_values;
  }
}

function iucn_assessment_field_group_pre_render(&$element, &$group, &$rendering_object) {
  if (!empty($element['#group_name']) && $element['#group_name'] == 'group_conservation_outlook') {
    if (!empty($element['field_as_end_date']['#object']->field_as_cycle)) {
      $element['#title'] = $element['field_as_end_date']['#object']->field_as_cycle->value . ' ' . $element['#title'];
    }
  }
}

/**
 * Implements hook_webform_element_alter().
 */
function iucn_assessment_webform_element_alter(array &$element, \Drupal\Core\Form\FormStateInterface $form_state, array $context) {
  if ($element['#webform_id'] == 'site_feedback--subject' && $element['#webform_key'] == 'subject') {
    /* @var \Drupal\node\Entity\Node $node */
    $node = \Drupal::routeMatch()->getParameter('node');
    if (is_object($node) && $node->bundle() == 'site') {
      $element['#default_value'] = t('Feedback on @site', ['@site' => $node->getTitle()]);
      $element['#attributes']['readonly'] = 'readonly';
    }
  }
}
